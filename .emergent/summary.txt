<analysis>**original_problem_statement:**
The user wants to create a website for a truck auto parts store.

**PRODUCT REQUIREMENTS:**
- **Core Functionality:** A complete e-commerce platform with a product catalog, shopping cart, and checkout process.
- **Search:** Advanced search by part number, name, and cross-reference.
- **Product Management:** Admin can manage products, including multiple photos, cross-reference numbers, and CSV/Excel import.
- **User Management:** Admin can manage users, including viewing their real passwords. Users can fully edit their profiles.
- **Order Management:** Admin can manage orders in real-time. Detailed Telegram notifications for new orders. Users can view their detailed order history and statistics.
- **Promotions & Homepage:** Manageable promotional banner and a block for partner brand logos.
- **Live Chat:** A built-in live chat with media support, integrated with a Telegram bot for admin replies. Images/videos must be viewable in an in-app lightbox. Admins can also send media from the admin panel.
- **Bonus Program (Advanced):**
    - Admin can create, edit, and delete multiple, independent bonus programs.
    - Currency is points, not rubles.
    - Each program has an editable title, an extended description, an image, and a multi-level structure (e.g., Bronze, Silver, Gold) with different point thresholds and rewards.
    - Admin can add specific prizes (with name, point cost, and image) that users can redeem with their points.
    - Users can spend points to claim available prizes.
- **Admin Dashboard:** A comprehensive statistics page and an enhanced user management section.

**User's preferred language**: Russian

**what currently exists?**
A full-stack e-commerce application (React, FastAPI, MongoDB) for a truck parts store. It features a complete admin panel for managing products, users, orders, partners, and a highly customized, multi-level bonus system with redeemable prizes. File and media uploads for chat and other features are now handled by Cloudinary. The user-facing side includes advanced search, full profile management, a shopping cart, detailed order history, and a feature-rich chat widget that supports images, videos, and files, all opening in a lightbox.

**Last working item**:
- **Last item agent was working:** The user requested a redesign of the bonus program display on the user's account page. The requirements are:
    1.  Create a separate, distinct UI element to show the user's total accumulated bonus points.
    2.  Remove the existing progress bar related to bonus programs.
    3.  Add a new progress bar that shows the user's total spend on 'delivered' orders for the current calendar year (January 1st to December 31st).
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** backend testing agent
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- No pending issues.

**In progress Task List**:
- **Task 1: Refactor Bonus UI & Add Yearly Order Progress Bar (P0)**
  - **Where to resume:** The agent has identified the backend endpoint  in .
    1.  **Backend:** Modify this endpoint to calculate the total sum of the user's 'delivered' orders within the current calendar year and include this value in the API response.
    2.  **Frontend:** Modify  to consume the new data. Implement the UI changes: display total bonus points in a new card, remove the old progress bar, and add the new yearly order progress bar.
  - **What will be achieved with this?** The user's account page will be updated to the new design, separating the display of accumulated points from a new yearly purchase progress metric, providing a clearer overview for the user.
  - **Status:** IN PROGRESS
  - **Should Test frontend/backend/both after fix?** both
  - **Blocked on something:** None.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - **P1:** Add pagination and search functionality to the user list in the admin panel.
    - **P1:** Implement an export feature for order statistics (Excel/PDF) in the admin dashboard.
    - **P2:** Send a Telegram notification to the user when the admin issues a bonus promo code.
- **Future Tasks:**
    - Search by VIN/truck model.
    - Product reviews.
    - Delivery cost calculator by region.

**Completed work in this session**
- **Chat Media Overhaul:**
    - Fixed a bug where images in chat opened in a new tab. Implemented an in-app lightbox for both images and videos.
    - Standardized media previews in the chat to be small, clickable thumbnails.
    - The fix was applied to both the user-facing  and the  chat interface.
- **File Upload Migration to Cloudinary:**
    - Implemented support for uploading images, videos, and generic files in the chat for both users and admins.
    - Migrated the file storage backend from an unreliable local setup to Cloudinary. This resolved issues with broken image links. The initial attempt to use Google Drive failed due to API limitations.
- **Partner Image Uploads:** Added a feature for admins to upload partner logos directly via Cloudinary from the admin panel, replacing the previous URL input field.
- **Bonus Program Major Enhancements:**
    - **Prizes & Points System:** Replaced currency (â‚½) with points, and enabled admins to add redeemable prizes (with names, point costs, and images) to each bonus program.
    - **Multi-Level Structure:** Implemented a level-based system (e.g., Bronze, Silver, Gold), allowing admins to configure different reward tiers based on accumulated points.
    - **Extended Descriptions:** Added a rich text field for admins to provide detailed descriptions for each bonus program.
    - **UI/UX Cleanup:** Removed the Your Progress text and the minimum payout threshold requirement, simplifying the user experience.

**Earlier issues found/mentioned but not fixed**
- None.

**Known issue recurrence from previous fork**
- None.

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI
- **Frontend:** React
- **Database:** MongoDB
- **Authentication:** JWT
- **Styling:** Tailwind CSS, Shadcn/UI
- **Media Storage:** Cloudinary (New)

**key DB schema**
- **bonus_programs:** The schema was significantly expanded to include:
    - 
    - 
    - 
- **chat_messages:**  now stores a Cloudinary URL.

**changes in tech stack**
- **Added:** Cloudinary is now used for all media and file storage.

**All files of reference**
- : Heavily modified to integrate Cloudinary, add new upload endpoints (for chat and partners), and completely overhaul the bonus program logic (points, prizes, levels, yearly total calculation).
- : Significantly updated to support file uploads in chat and management of the new advanced bonus program features (prizes with images, levels). Implemented a lightbox for media.
- : Overhauled to display the new multi-level bonus program with prizes and points. This is the primary file for the current task.
- : Refactored to handle Cloudinary URLs, display media thumbnails, and open images/videos in a lightbox.
- : New file created to encapsulate all Cloudinary API interactions.
- : Updated with Cloudinary API credentials.
- : Obsolete file from a failed integration attempt.

**Areas that need refactoring**:
-  and  remain large monoliths that would benefit from being broken down into smaller, more focused modules/components.
- The files  and  are obsolete after the switch to Cloudinary and should be removed to clean up the codebase.

**key api endpoints**
-  (POST): Handles user media uploads to chat via Cloudinary.
-  (POST): Handles admin media uploads to chat via Cloudinary.
-  (POST): Handles partner logo uploads.
-  (POST): Allows users to spend points on prizes.
-  (GET, POST, PUT): Manages all aspects of bonus programs, including levels and prizes.
-  (GET): Returns program details, including levels and prizes, to the user. This is the endpoint to be modified for the current task.

**Critical Info for New Agent**
- The immediate priority is to modify the bonus program display on the user's account page as per the last user request (separate points display, remove progress bar, add yearly order total bar). This involves work on both the backend () and frontend ().
- All file uploads are now handled by **Cloudinary**. The code for the previous Google Drive attempt () is still in the repository but is unused and should be ignored.
- The bonus system is now based on points, redeemable prizes, and a multi-level structure. Ensure all related logic adheres to this new model.

**documents and test reports created in this job**
- 

**Last 10 User Messages and any pending HUMAN messages**
10. **User:** remove the minimum threshold for prize requests in the bonus program (COMPLETED)
9. **User:** can you give me advice on improving the bonus program...? (COMPLETED - Agent provided suggestions)
8. **User:** add an extended description, change rubles to points, add prizes, and allow spending points (COMPLETED)
7. **User:** remove the text above the progress bar in the bonus program (COMPLETED)
6. **User:** files open on another page...they should open on the main page (COMPLETED - Implemented lightbox in admin panel)
5. **User:** chat images are too big, make them small thumbnails... (COMPLETED)
4. **User:** add the ability to upload photos to partners in the admin panel (COMPLETED)
3. **User:** add image/video/file support to chat for users and admins... and store files on my google drive (COMPLETED - Implemented with Cloudinary after Google Drive failed)
2. **User:** images in chat still not showing, just a broken file... (COMPLETED - This was the initial bug that was fixed)
1. **User:** make a separate cell showing the number of bonuses... remove the progress bar. Make a bar that shows the total amount of all delivered orders for one calendar year (PENDING - This is the current task)

**Project Health Check:**
- **Broken:** None.
- **Mocked:** Application data is transient and resets with each new session.

**3rd Party Integrations**
- **Telegram (via ):** Used for order notifications and the admin-user live chat bridge.
- **Cloudinary:** Used for all media and file storage. Credentials are in .

**Testing status**
- **Testing agent used after significant changes:** NO
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** None.
- **Known regressions:** None.

**Credentials to test flow:**
- **Admin Email:** 
- **Admin Password:** 
- **Test User Email:** 
- **Test User Password:** 

**What agent forgot to execute**
- The agent correctly identified and started working on the user's most recent request. Nothing was forgotten.</analysis>
